{
  "title": "Troubles setting up Adobe Target Prehiding in a NextJS app",
  "date": "2023-06-13T00:00:00.000Z",
  "tags": [
    "adobe target",
    "react",
    "nextjs",
    "prehiding",
    "ab testing"
  ],
  "draft": false,
  "summary": "Watch as I attempt to set up content prehiding for Adobe Target activities on this very blog!",
  "body": {
    "raw": "\n## The Adobe Target/Personalization Prehiding Snippet\n\nI did not write the code for this blog. It uses the [Tailwind Starter Blog Template](https://github.com/timlrx/tailwind-nextjs-starter-blog) which uses\nNextJS, React, and Tailwind CSS. 90% of the code I will never touch. I have, however,\ndone some customization and deployed the Adobe Web SDK, amongst other things. Since I also\nuse this site as a sandbox for proof-of-concept projects in Adobe Target, I have also setup [Adobe Target prehiding](https://experienceleague.adobe.com/docs/platform-learn/implement-in-websites/implement-solutions/target.html?lang=en#add-the-target-pre-hiding-snippet).\nI need to make sure that content doesn't flicker and hinder the user experience for my 7 readers :)\n\nI'm going to lay out how I have implemented prehiding on this site in the in hopes that it will help\nothers get their own setup in order. My examples here use Adobe Web SDK prehiding setup, so the code will\nbe a _little_ different from what is used for `AT.js`, but the concepts should be the same.\n\nAs website building tools and javascript frameworks get more complicated, placing your prehiding code has become a bespoke process.\nIts even harder when you are only _kind of_ a developer like me. Telling someone _\"Just put it at the top of the page\"_ has sort of lost its meaning,\nas most pages these days are just almogomations of React components. What even is a _page_ anymore, man? Anyway...\n\nIn the Web SDK specifically, its a challenge to have your [render personalization](https://experienceleague.adobe.com/docs/experience-platform/edge/personalization/rendering-personalization-content.html?lang=en)\nin sync with your data layer eventing, what is happening on your UI, and what Target is returning.\n\nIf you are using the Adobe Web SDK you can find the Target prehiding snippet in the Web SDK extension:\n\n![prehide snippet location](https://images.ctfassets.net/on47yk52ubpi/18sQ2towWyVvysCfrb9pxZ/c9d4a59f0f4a5e8622d225ff85fed595/prehidesnippetlocation.png)\n\n<figure>\n  <figcaption>\n    I have yet to figure out what the **Prehiding Style** section above the code snippet section is\n    for. I mean I get what its says it will do, but I have never gotten it to really have an effect\n    on anything.\n  </figcaption>\n</figure>\n\nThe code below is what you are copying out of the extension:\n\n```javascript\n<script>\n  !function(e,a,n,t){var i=e.head;if(i){\n  if (a) return;\n  var o=e.createElement(\"style\");\n  o.id=\"alloy-prehiding\",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)}}\n  (document, document.location.href.indexOf(\"adobe_authoring_enabled\") !== -1, \".personalization-container { opacity: 0 !important }\", 3000);\n</script>\n```\n\nAt a high level, this code gives you a class called `.personalization-container` to place on elements that may be affected by\nTarget/personalization efforts. This class will make elements with it are invisible (opacity 0) for 3 seconds _or_ until a personalization response\nis sent back from the Adobe Edge Network.\n\nI have _slightly_ [modified my code](https://github.com/perpetua-digital/perpetuadigitalwebsite/blob/main/components/analytics/Prehide.tsx) to\nuse `.prehide` as the class name instead of `.personalization-container` because the word \"personalization\" feels too ambitious for my little blog here.\nYou can see my prehide code in [my repo](https://github.com/perpetua-digital/perpetuadigitalwebsite/tree/main) under `public > static > scripts > prehide.js`\n![my prehide code](https://images.ctfassets.net/on47yk52ubpi/zxfUdqX2qdFw67CdnY561/8bd95ed06a4b7a40a63f19b421098bc1/myprehidecode2.png)\n\n<figure>\n  <figcaption>\n    Throw a little console log in there too just as a sanity check. I should probably make that a\n    _satellite.log\n  </figcaption>\n</figure>\n\nI then load `prehide.js` in my main `_app` file which in turn loads the snippet on every page load and makes my `.prehide` class available.\nThis method makes prehiding _work for me_, your experience may vary. By _works for me_,\nI mean that it prehides my elements tagged with the `.prehide` class until my Web SDK response returns with a personalization decision.\nThat is exactly what the prehide snippet is supposed to do. However, this implementation method seems to go against everything the [NextJS documentation says to do\nwhen working with external scripts](https://nextjs.org/docs/pages/building-your-application/optimizing/scripts).\nHere are the other ways I tried to incorporate this snippet before I came to this setup:\n\n## Methods that didn't work\n\n### React Component\n\nFirst, I tried matching the original author of this template's structure of other analytics components and made a\nfunctional react component out of it.\n\n```javascript\nimport Script from 'next/script'\n\nconst Prehide = () => {\n  return (\n    <>\n      <Script strategy=\"afterInteractive\" id=\"adobe-prehide\">\n        {`\n            console.log('begin prehide')\n            !function(e,a,n,t){var i=e.head;if(i){\n                if (a) return;\n                var o=e.createElement(\"style\");\n                o.id=\"alloy-prehiding\",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)}}\n                (document, document.location.href.indexOf(\"adobe_authoring_enabled\") !== -1, \".prehide { opacity: 0 !important }\", 3000);console.log(\"prehiding....\")\n        `}\n      </Script>\n    </>\n  )\n}\n\nexport default Prehide\n```\n\nThis _kinda_ worked, depending on where I tried to load it. Importing into the `_app.tsx` file\nwith the other analytics components would yield prehiding on _some_ tagged components, but seemed\nto be in a race with the hydration of the page elements.\n\nChanging the [script strategy](https://nextjs.org/docs/pages/building-your-application/optimizing/scripts#strategy)\nhad no effect. A prehidden tagged component would load, be shown, dissappear, then re-appear with test content from Target.\nGood behavior, in theory, but the timing was off. I tried importing it into the [\\_document.tsx file](https://nextjs.org/docs/pages/building-your-application/routing/custom-document), but that had no effect at all.\nI believe this is because code in `_document` is not read by the browser.\n\n### Inline Scripts\n\nNext up was formatting the component using [NextJS inline scripts](https://nextjs.org/docs/pages/building-your-application/optimizing/scripts#inline-scripts) formatting.\nI could not get the prehiding snippet to work at all with this formatting. I don't know why. I couldn't even get console.logs to work here either.\n\n```javascript\n<Script id=\"adobe-prehide\">\n  {`!function(e,a,n,t){var i=e.head;if(i){\n  if (a) return;\n  var o=e.createElement(\"style\");\n  o.id=\"alloy-prehiding\",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)}}\n  (document, document.location.href.indexOf(\"adobe_authoring_enabled\") !== -1, \".prehide { opacity: 0 !important }\", 3000);`}\n</Script>\n```\n\nUsing the `dangerouslySetInnerHTML` to set the prehide snippet in a `next/script` component also\nhad no effect on prehiding elements. I don't know why `¯\\_(ツ)_/¯`\n\n## Prehiding in Action\n\nI have a few elements on this site tagged for prehiding. I am using the strategy of tagging individual\nelements instead of entire section so as to not hinder my web vitals scores.\n\n### Subhead\n\nThis little subheadline on the homepage is gray by default, but I use Target to turn it green. The prehiding code prevents the default one from showing before Target can do its thing.\n\n![subhead default](https://images.ctfassets.net/on47yk52ubpi/1j34Yd1FrEPSUKr9dbNyeq/4a5c1b2a3a96c17932f617783fec3ba4/subheaddefault.png)\n\n![subhead gif](https://images.ctfassets.net/on47yk52ubpi/2Ql5IvLO73bq0pSGfjHJ1I/832f922e37cc7122647b431b262922fa/subheadprehidetarget.gif)\n\n<figure>\n  <figcaption>\n    Prehiding prevents the gray headline from flickering into the green one. (The shift is from the\n    page reload)\n  </figcaption>\n</figure>\n\n---\n\n### About me image\n\n![avatar prehide gif](https://images.ctfassets.net/on47yk52ubpi/4DK73lK82tM9BuyveW74tm/b7e1583a2bf3a4527a1faf0db3071003/avatarprehide.gif)\n\nThe profile image here has the prehiding class so you'll see it load slightly after the rest of\nthe content. If I had a Target activity that altered that image, the activity's content would\nreplace the hardcoded image seamlessly.\n\n```javascript\n<Image\n  src={avatar}\n  alt=\"avatar\"\n  width=\"192px\"\n  height=\"192px\"\n  className=\"prehide h-48 w-48 rounded-full\"\n/>\n```\n\n<figure>\n  <figcaption>`prehide` class on the image react component</figcaption>\n</figure>\n\n## What did I learn?\n\nIn the end, I got it to work, but I don't know exactly why. I guess what I learned here to keep trying until something works! If anyone has successfully integrated\nTarget prehiding into a React/NextJS app such as mine, please reach out!\n\nSometimes when working on this stuff I feel like JK Simmons' character in this clip\n\n<ReactPlayer url=\"https://www.youtube.com/watch?v=J6VjPM5CeWs\" />\n",
    "code": "var Component=(()=>{var d=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var g=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports),N=(a,t)=>{for(var s in t)c(a,s,{get:t[s],enumerable:!0})},o=(a,t,s,n)=>{if(t&&typeof t==\"object\"||typeof t==\"function\")for(let i of h(t))!u.call(a,i)&&i!==s&&c(a,i,{get:()=>t[i],enumerable:!(n=p(t,i))||n.enumerable});return a};var k=(a,t,s)=>(s=a!=null?d(m(a)):{},o(t||!a||!a.__esModule?c(s,\"default\",{value:a,enumerable:!0}):s,a)),f=a=>o(c({},\"__esModule\",{value:!0}),a);var l=g((T,r)=>{r.exports=_jsx_runtime});var x={};N(x,{default:()=>w,frontmatter:()=>y});var e=k(l()),y={title:\"Troubles setting up Adobe Target Prehiding in a NextJS app\",date:\"2023-06-13\",tags:[\"adobe target\",\"react\",\"nextjs\",\"prehiding\",\"ab testing\"],draft:!1,summary:\"Watch as I attempt to set up content prehiding for Adobe Target activities on this very blog!\"};function b(a={}){let{wrapper:t}=a.components||{};return t?(0,e.jsx)(t,Object.assign({},a,{children:(0,e.jsx)(s,{})})):s();function s(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",em:\"em\",code:\"code\",img:\"img\",strong:\"strong\",pre:\"pre\",h3:\"h3\",hr:\"hr\"},a.components),{ReactPlayer:i}=n;return i||v(\"ReactPlayer\",!0,\"183:1-183:66\"),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"the-adobe-targetpersonalization-prehiding-snippet\",children:[(0,e.jsx)(n.a,{href:\"#the-adobe-targetpersonalization-prehiding-snippet\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"The Adobe Target/Personalization Prehiding Snippet\"]}),(0,e.jsxs)(n.p,{children:[\"I did not write the code for this blog. It uses the \",(0,e.jsx)(n.a,{href:\"https://github.com/timlrx/tailwind-nextjs-starter-blog\",children:\"Tailwind Starter Blog Template\"}),\" which uses NextJS, React, and Tailwind CSS. 90% of the code I will never touch. I have, however, done some customization and deployed the Adobe Web SDK, amongst other things. Since I also use this site as a sandbox for proof-of-concept projects in Adobe Target, I have also setup \",(0,e.jsx)(n.a,{href:\"https://experienceleague.adobe.com/docs/platform-learn/implement-in-websites/implement-solutions/target.html?lang=en#add-the-target-pre-hiding-snippet\",children:\"Adobe Target prehiding\"}),\". I need to make sure that content doesn't flicker and hinder the user experience for my 7 readers :)\"]}),(0,e.jsxs)(n.p,{children:[\"I'm going to lay out how I have implemented prehiding on this site in the in hopes that it will help others get their own setup in order. My examples here use Adobe Web SDK prehiding setup, so the code will be a \",(0,e.jsx)(n.em,{children:\"little\"}),\" different from what is used for \",(0,e.jsx)(n.code,{children:\"AT.js\"}),\", but the concepts should be the same.\"]}),(0,e.jsxs)(n.p,{children:[\"As website building tools and javascript frameworks get more complicated, placing your prehiding code has become a bespoke process. Its even harder when you are only \",(0,e.jsx)(n.em,{children:\"kind of\"}),\" a developer like me. Telling someone \",(0,e.jsx)(n.em,{children:'\"Just put it at the top of the page\"'}),\" has sort of lost its meaning, as most pages these days are just almogomations of React components. What even is a \",(0,e.jsx)(n.em,{children:\"page\"}),\" anymore, man? Anyway...\"]}),(0,e.jsxs)(n.p,{children:[\"In the Web SDK specifically, its a challenge to have your \",(0,e.jsx)(n.a,{href:\"https://experienceleague.adobe.com/docs/experience-platform/edge/personalization/rendering-personalization-content.html?lang=en\",children:\"render personalization\"}),\" in sync with your data layer eventing, what is happening on your UI, and what Target is returning.\"]}),(0,e.jsx)(n.p,{children:\"If you are using the Adobe Web SDK you can find the Target prehiding snippet in the Web SDK extension:\"}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{alt:\"prehide snippet location\",src:\"https://images.ctfassets.net/on47yk52ubpi/18sQ2towWyVvysCfrb9pxZ/c9d4a59f0f4a5e8622d225ff85fed595/prehidesnippetlocation.png\"})}),(0,e.jsx)(\"figure\",{children:(0,e.jsx)(\"figcaption\",{children:(0,e.jsxs)(n.p,{children:[\"I have yet to figure out what the \",(0,e.jsx)(n.strong,{children:\"Prehiding Style\"}),\" section above the code snippet section is for. I mean I get what its says it will do, but I have never gotten it to really have an effect on anything.\"]})})}),(0,e.jsx)(n.p,{children:\"The code below is what you are copying out of the extension:\"}),(0,e.jsx)(n.pre,{className:\"language-javascript\",children:(0,e.jsxs)(n.code,{className:\"language-javascript code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"script\",(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsxs)(n.span,{className:\"token parameter\",children:[\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"a\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"t\"]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"var\"}),\" i\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"head\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"if\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"if\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"a\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"var\"}),\" o\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"e\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access function method\",children:\"createElement\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"style\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"id\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"alloy-prehiding\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"innerText\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"n\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"i\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access function method\",children:\"appendChild\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"setTimeout\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"function\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\"o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"parentNode\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"&&\"}),\"o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"parentNode\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access function method\",children:\"removeChild\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"o\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\"t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token dom variable\",children:\"document\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token dom variable\",children:\"document\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"location\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access\",children:\"href\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token property-access function method\",children:\"indexOf\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"adobe_authoring_enabled\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!==\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:'\".personalization-container { opacity: 0 !important }\"'}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"3000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),\"script\",(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"At a high level, this code gives you a class called \",(0,e.jsx)(n.code,{children:\".personalization-container\"}),\" to place on elements that may be affected by Target/personalization efforts. This class will make elements with it are invisible (opacity 0) for 3 seconds \",(0,e.jsx)(n.em,{children:\"or\"}),\" until a personalization response is sent back from the Adobe Edge Network.\"]}),(0,e.jsxs)(n.p,{children:[\"I have \",(0,e.jsx)(n.em,{children:\"slightly\"}),\" \",(0,e.jsx)(n.a,{href:\"https://github.com/perpetua-digital/perpetuadigitalwebsite/blob/main/components/analytics/Prehide.tsx\",children:\"modified my code\"}),\" to use \",(0,e.jsx)(n.code,{children:\".prehide\"}),\" as the class name instead of \",(0,e.jsx)(n.code,{children:\".personalization-container\"}),' because the word \"personalization\" feels too ambitious for my little blog here. You can see my prehide code in ',(0,e.jsx)(n.a,{href:\"https://github.com/perpetua-digital/perpetuadigitalwebsite/tree/main\",children:\"my repo\"}),\" under \",(0,e.jsx)(n.code,{children:\"public > static > scripts > prehide.js\"}),\" \",(0,e.jsx)(n.img,{alt:\"my prehide code\",src:\"https://images.ctfassets.net/on47yk52ubpi/zxfUdqX2qdFw67CdnY561/8bd95ed06a4b7a40a63f19b421098bc1/myprehidecode2.png\"})]}),(0,e.jsx)(\"figure\",{children:(0,e.jsx)(\"figcaption\",{children:(0,e.jsx)(n.p,{children:\"Throw a little console log in there too just as a sanity check. I should probably make that a _satellite.log\"})})}),(0,e.jsxs)(n.p,{children:[\"I then load \",(0,e.jsx)(n.code,{children:\"prehide.js\"}),\" in my main \",(0,e.jsx)(n.code,{children:\"_app\"}),\" file which in turn loads the snippet on every page load and makes my \",(0,e.jsx)(n.code,{children:\".prehide\"}),\" class available. This method makes prehiding \",(0,e.jsx)(n.em,{children:\"work for me\"}),\", your experience may vary. By \",(0,e.jsx)(n.em,{children:\"works for me\"}),\", I mean that it prehides my elements tagged with the \",(0,e.jsx)(n.code,{children:\".prehide\"}),\" class until my Web SDK response returns with a personalization decision. That is exactly what the prehide snippet is supposed to do. However, this implementation method seems to go against everything the \",(0,e.jsx)(n.a,{href:\"https://nextjs.org/docs/pages/building-your-application/optimizing/scripts\",children:\"NextJS documentation says to do when working with external scripts\"}),\". Here are the other ways I tried to incorporate this snippet before I came to this setup:\"]}),(0,e.jsxs)(n.h2,{id:\"methods-that-didnt-work\",children:[(0,e.jsx)(n.a,{href:\"#methods-that-didnt-work\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Methods that didn't work\"]}),(0,e.jsxs)(n.h3,{id:\"react-component\",children:[(0,e.jsx)(n.a,{href:\"#react-component\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"React Component\"]}),(0,e.jsx)(n.p,{children:\"First, I tried matching the original author of this template's structure of other analytics components and made a functional react component out of it.\"}),(0,e.jsx)(n.pre,{className:\"language-javascript\",children:(0,e.jsxs)(n.code,{className:\"language-javascript code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,e.jsx)(n.span,{className:\"token imports\",children:(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Script\"})}),\" \",(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'next/script'\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token function function-variable\",children:(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Prehide\"})}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator arrow\",children:\"=>\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token keyword control-flow\",children:\"return\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Script\"}),\" strategy\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"afterInteractive\"'}),\" id\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"adobe-prehide\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsxs)(n.span,{className:\"token template-string\",children:[(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"}),(0,e.jsx)(n.span,{className:\"token string\",children:`\n`})]})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`            console.log('begin prehide')\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`            !function(e,a,n,t){var i=e.head;if(i){\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`                if (a) return;\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`                var o=e.createElement(\"style\");\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`                o.id=\"alloy-prehiding\",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)}}\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`                (document, document.location.href.indexOf(\"adobe_authoring_enabled\") !== -1, \".prehide { opacity: 0 !important }\", 3000);console.log(\"prehiding....\")\n`})})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token template-string\",children:[(0,e.jsx)(n.span,{className:\"token string\",children:\"        \"}),(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Script\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"export\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword module\",children:\"default\"}),\" \",(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Prehide\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"This \",(0,e.jsx)(n.em,{children:\"kinda\"}),\" worked, depending on where I tried to load it. Importing into the \",(0,e.jsx)(n.code,{children:\"_app.tsx\"}),\" file with the other analytics components would yield prehiding on \",(0,e.jsx)(n.em,{children:\"some\"}),\" tagged components, but seemed to be in a race with the hydration of the page elements.\"]}),(0,e.jsxs)(n.p,{children:[\"Changing the \",(0,e.jsx)(n.a,{href:\"https://nextjs.org/docs/pages/building-your-application/optimizing/scripts#strategy\",children:\"script strategy\"}),\" had no effect. A prehidden tagged component would load, be shown, dissappear, then re-appear with test content from Target. Good behavior, in theory, but the timing was off. I tried importing it into the \",(0,e.jsx)(n.a,{href:\"https://nextjs.org/docs/pages/building-your-application/routing/custom-document\",children:\"_document.tsx file\"}),\", but that had no effect at all. I believe this is because code in \",(0,e.jsx)(n.code,{children:\"_document\"}),\" is not read by the browser.\"]}),(0,e.jsxs)(n.h3,{id:\"inline-scripts\",children:[(0,e.jsx)(n.a,{href:\"#inline-scripts\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Inline Scripts\"]}),(0,e.jsxs)(n.p,{children:[\"Next up was formatting the component using \",(0,e.jsx)(n.a,{href:\"https://nextjs.org/docs/pages/building-your-application/optimizing/scripts#inline-scripts\",children:\"NextJS inline scripts\"}),\" formatting. I could not get the prehiding snippet to work at all with this formatting. I don't know why. I couldn't even get console.logs to work here either.\"]}),(0,e.jsx)(n.pre,{className:\"language-javascript\",children:(0,e.jsxs)(n.code,{className:\"language-javascript code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Script\"}),\" id\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"adobe-prehide\"'}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsxs)(n.span,{className:\"token template-string\",children:[(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"}),(0,e.jsx)(n.span,{className:\"token string\",children:`!function(e,a,n,t){var i=e.head;if(i){\n`})]})]}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`  if (a) return;\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`  var o=e.createElement(\"style\");\n`})})}),(0,e.jsx)(n.span,{className:\"code-line\",children:(0,e.jsx)(n.span,{className:\"token template-string\",children:(0,e.jsx)(n.span,{className:\"token string\",children:`  o.id=\"alloy-prehiding\",o.innerText=n,i.appendChild(o),setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},t)}}\n`})})}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsxs)(n.span,{className:\"token template-string\",children:[(0,e.jsx)(n.span,{className:\"token string\",children:'  (document, document.location.href.indexOf(\"adobe_authoring_enabled\") !== -1, \".prehide { opacity: 0 !important }\", 3000);'}),(0,e.jsx)(n.span,{className:\"token string template-punctuation\",children:\"`\"})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Script\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]})]})}),(0,e.jsxs)(n.p,{children:[\"Using the \",(0,e.jsx)(n.code,{children:\"dangerouslySetInnerHTML\"}),\" to set the prehide snippet in a \",(0,e.jsx)(n.code,{children:\"next/script\"}),\" component also had no effect on prehiding elements. I don't know why \",(0,e.jsx)(n.code,{children:\"\\xAF\\\\_(\\u30C4)_/\\xAF\"})]}),(0,e.jsxs)(n.h2,{id:\"prehiding-in-action\",children:[(0,e.jsx)(n.a,{href:\"#prehiding-in-action\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Prehiding in Action\"]}),(0,e.jsx)(n.p,{children:\"I have a few elements on this site tagged for prehiding. I am using the strategy of tagging individual elements instead of entire section so as to not hinder my web vitals scores.\"}),(0,e.jsxs)(n.h3,{id:\"subhead\",children:[(0,e.jsx)(n.a,{href:\"#subhead\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Subhead\"]}),(0,e.jsx)(n.p,{children:\"This little subheadline on the homepage is gray by default, but I use Target to turn it green. The prehiding code prevents the default one from showing before Target can do its thing.\"}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{alt:\"subhead default\",src:\"https://images.ctfassets.net/on47yk52ubpi/1j34Yd1FrEPSUKr9dbNyeq/4a5c1b2a3a96c17932f617783fec3ba4/subheaddefault.png\"})}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{alt:\"subhead gif\",src:\"https://images.ctfassets.net/on47yk52ubpi/2Ql5IvLO73bq0pSGfjHJ1I/832f922e37cc7122647b431b262922fa/subheadprehidetarget.gif\"})}),(0,e.jsx)(\"figure\",{children:(0,e.jsx)(\"figcaption\",{children:(0,e.jsx)(n.p,{children:\"Prehiding prevents the gray headline from flickering into the green one. (The shift is from the page reload)\"})})}),(0,e.jsx)(n.hr,{}),(0,e.jsxs)(n.h3,{id:\"about-me-image\",children:[(0,e.jsx)(n.a,{href:\"#about-me-image\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"About me image\"]}),(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{alt:\"avatar prehide gif\",src:\"https://images.ctfassets.net/on47yk52ubpi/4DK73lK82tM9BuyveW74tm/b7e1583a2bf3a4527a1faf0db3071003/avatarprehide.gif\"})}),(0,e.jsx)(n.p,{children:\"The profile image here has the prehiding class so you'll see it load slightly after the rest of the content. If I had a Target activity that altered that image, the activity's content would replace the hardcoded image seamlessly.\"}),(0,e.jsx)(n.pre,{className:\"language-javascript\",children:(0,e.jsxs)(n.code,{className:\"language-javascript code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token maybe-class-name\",children:\"Image\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  src\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),\"avatar\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  alt\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"avatar\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  width\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"192px\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  height\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"192px\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  className\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token string\",children:'\"prehide h-48 w-48 rounded-full\"'}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]})]})}),(0,e.jsx)(\"figure\",{children:(0,e.jsxs)(\"figcaption\",{children:[(0,e.jsx)(n.code,{children:\"prehide\"}),\" class on the image react component\"]})}),(0,e.jsxs)(n.h2,{id:\"what-did-i-learn\",children:[(0,e.jsx)(n.a,{href:\"#what-did-i-learn\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"What did I learn?\"]}),(0,e.jsx)(n.p,{children:\"In the end, I got it to work, but I don't know exactly why. I guess what I learned here to keep trying until something works! If anyone has successfully integrated Target prehiding into a React/NextJS app such as mine, please reach out!\"}),(0,e.jsx)(n.p,{children:\"Sometimes when working on this stuff I feel like JK Simmons' character in this clip\"}),(0,e.jsx)(i,{url:\"https://www.youtube.com/watch?v=J6VjPM5CeWs\"})]})}}var w=b;function v(a,t,s){throw new Error(\"Expected \"+(t?\"component\":\"object\")+\" `\"+a+\"` to be defined: you likely forgot to import, pass, or provide it.\"+(s?\"\\nIt\\u2019s referenced in your code at `\"+s+\"` in `/Users/john/Desktop/code/perpetuadigitalwebsite/_mdx_bundler_entry_point-3d66cf8d-2444-42f4-9fd1-9c27cbc2e20d.mdx`\":\"\"))}return f(x);})();\n;return Component;"
  },
  "_id": "blog/adobe-target-prehiding-in-react-and-nextjs.mdx",
  "_raw": {
    "sourceFilePath": "blog/adobe-target-prehiding-in-react-and-nextjs.mdx",
    "sourceFileName": "adobe-target-prehiding-in-react-and-nextjs.mdx",
    "sourceFileDir": "blog",
    "contentType": "mdx",
    "flattenedPath": "blog/adobe-target-prehiding-in-react-and-nextjs"
  },
  "type": "Blog",
  "readingTime": {
    "text": "6 min read",
    "minutes": 5.445,
    "time": 326700,
    "words": 1089
  },
  "slug": "adobe-target-prehiding-in-react-and-nextjs",
  "toc": [
    {
      "value": "The Adobe Target/Personalization Prehiding Snippet",
      "url": "#the-adobe-targetpersonalization-prehiding-snippet",
      "depth": 2
    },
    {
      "value": "Methods that didn't work",
      "url": "#methods-that-didnt-work",
      "depth": 2
    },
    {
      "value": "React Component",
      "url": "#react-component",
      "depth": 3
    },
    {
      "value": "Inline Scripts",
      "url": "#inline-scripts",
      "depth": 3
    },
    {
      "value": "Prehiding in Action",
      "url": "#prehiding-in-action",
      "depth": 2
    },
    {
      "value": "Subhead",
      "url": "#subhead",
      "depth": 3
    },
    {
      "value": "About me image",
      "url": "#about-me-image",
      "depth": 3
    },
    {
      "value": "What did I learn?",
      "url": "#what-did-i-learn",
      "depth": 2
    }
  ]
}